# üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Backtest Engine

## –§–∏–ª–æ—Å–æ—Ñ–∏—è –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞ –≤ —Å–∫–∞–ª—å–ø–∏–Ω–≥–µ

**"–ë—ç–∫—Ç–µ—Å—Ç –Ω–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"**

–ù–∞—à –±—ç–∫—Ç–µ—Å—Ç–µ—Ä —Ä–µ–∞–ª–∏–∑—É–µ—Ç **—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–º—É–ª—è—Ç–æ—Ä**, –∞ –Ω–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä, –∫–∞–∫ –≤ MoonBot.

## –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –°–ª—É—á–∞–π–Ω–æ—Å—Ç—å –∏ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å

- **–õ–∞–≥ —Ç—Ä–µ–π–¥–æ–≤**: 10-20 –º—Å —Å–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- **–î–∏—Å–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç–∞**: —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ –∫–∞–∂–¥—ã–π —Ç–∏–∫
- **–°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫—É**: 10-20 –º—Å –¥–ª—è Sell –æ—Ä–¥–µ—Ä–æ–≤
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–∞ —Ç—Ä–µ–π–¥–∞**: —ç–º—É–ª—è—Ü–∏—è "–Ω–µ —É—Å–ø–µ–ª"

### 2. –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ —Å–∏–º—É–ª—è—Ü–∏—è

–ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –ø—Ä–æ–≥–æ–Ω—ã (N=100) —Å —Ä–∞–∑–Ω—ã–º–∏ seed –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏.

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ `Emulator` –ø—Ä–∏ –±—ç–∫—Ç–µ—Å—Ç–µ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
src/backtest/
‚îú‚îÄ‚îÄ mod.rs              # –ü—É–±–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îú‚îÄ‚îÄ engine.rs           # –û—Å–Ω–æ–≤–Ω–æ–π –¥–≤–∏–∂–æ–∫ –±—ç–∫—Ç–µ—Å—Ç–∞
‚îú‚îÄ‚îÄ emulator.rs         # –≠–º—É–ª—è—Ç–æ—Ä —Ä—ã–Ω–∫–∞ –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
‚îú‚îÄ‚îÄ market.rs           # –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞ –∏ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ metrics.rs          # –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
‚îú‚îÄ‚îÄ replay.rs           # –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ .bin —Ñ–∞–π–ª–æ–≤
‚îî‚îÄ‚îÄ bin_format.rs       # –§–æ—Ä–º–∞—Ç .bin —Ñ–∞–π–ª–æ–≤
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### BacktestEngine

–û—Å–Ω–æ–≤–Ω–æ–π –¥–≤–∏–∂–æ–∫, –∫–æ—Ç–æ—Ä—ã–π:
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä–µ—Å—á–µ—Ç—ã
- –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏

### MarketEmulator

–≠–º—É–ª–∏—Ä—É–µ—Ç:
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
- –°–∫–æ–ª—å–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã (slippage)
- –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

### TradeStream

–ü–æ—Ç–æ–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–π–¥–æ–≤ –∏–∑ .bin —Ñ–∞–π–ª–∞.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```rust
use rust_test::backtest::*;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ç–∫—Ç–µ—Å—Ç–∞
let settings = BacktestSettings {
    tick_interval_ms: 2,
    latency_ms_range: (10, 20),
    execution_delay_ms_range: (10, 20),
    reposition_delay_ms_range: (10, 20),
    recalculation_interval_ms: 50,
    random_seed: Some(12345), // –î–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
    ..Default::default()
};

// –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–æ–∫
let mut engine = BacktestEngine::new(settings);

// –ó–∞–≥—Ä—É–∂–∞–µ–º .bin —Ñ–∞–π–ª
let mut replay = ReplayEngine::new(Default::default());
replay.load_bin_file("data/Demo_BTC.bin")?;

// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Ç–æ–∫–∏ –≤ –¥–≤–∏–∂–æ–∫
for stream in replay.take_streams() {
    engine.add_stream(stream);
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫—Ç–µ—Å—Ç
let result = engine.run()?;

println!("P&L: {:.2}", result.total_pnl);
println!("Trades: {}", result.total_trades);
println!("Win Rate: {:.2}%", result.win_rate);

// –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ —Å–∏–º—É–ª—è—Ü–∏—è
let results = engine.run_monte_carlo(100)?;
```

## –§–∞–∫—Ç–æ—Ä—ã —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏

1. **Network latency jitter**: –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 10-20 –º—Å –Ω–∞ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
2. **Orderbook update lag**: –ë–æ—Ç –≤–∏–¥–∏—Ç —Ü–µ–Ω—É –Ω–µ –≤ —Ç–æ—Ç –∂–µ —Ç–∏–∫
3. **Execution slippage**: –°–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
4. **Out-of-sync recalculation**: –ü–µ—Ä–µ—Å—á–µ—Ç—ã –Ω–µ –∫–∞–∂–¥—ã–π —Ç–∏–∫
5. **Random missed trade**: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–∞ —Ç—Ä–µ–π–¥–∞

## –§–æ—Ä–º–∞—Ç .bin —Ñ–∞–π–ª–æ–≤

–ö–∞–∂–¥—ã–π —Ç—Ä–µ–π–¥ = 24 –±–∞–π—Ç–∞:
- timestamp (i64, 8 bytes)
- price (f64, 8 bytes)
- volume (f64, 8 bytes)
- side (bool, 1 byte –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –±–∞–π—Ç–µ)

–°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º MoonBot.

## –ú–µ—Ç—Ä–∏–∫–∏

- Total P&L
- Win Rate
- Profit Factor
- Max Drawdown
- Sharpe Ratio
- Average Profit/Loss
- Largest Win/Loss

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ–∞–ª–∏–∑—É—é—Ç trait `Strategy` –∏ –ø–æ–ª—É—á–∞—é—Ç —Å–æ–±—ã—Ç–∏—è:
- `on_tick(tick)` - –Ω–æ–≤—ã–π —Ç—Ä–µ–π–¥
- `on_order_filled(order)` - –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç —Ä–∞–∑–ª–∏—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –ø—Ä–æ–≥–æ–Ω–∞–º–∏ –∏–∑-–∑–∞ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏
- –†–µ–∂–∏–º `Emulator` –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

